image: php:8.2

stages:
  - lint
  - deploy

# Vérification de la syntaxe PHP
lint_php:
  stage: lint
  script:
    - find . -name "*.php" -exec php -l {} \;

# Déploiement vers le serveur cPanel via FTP
deploy_to_cpanel:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache lftp
  script:
    # Utiliser LFTP_PASSWORD (variable native de lftp qui gère les caractères spéciaux)
    - export LFTP_PASSWORD="$FTP_PASSWORD"
    # Connexion et déploiement
    - |
      lftp -u "$FTP_USER" "$FTP_SERVER" << EOF
      set ftp:ssl-allow no
      set ftp:passive-mode yes
      set net:timeout 30
      cd $FTP_PATH
      mirror -R --verbose --exclude .git/ --exclude .gitlab-ci.yml --exclude README.md --exclude .gitignore ./ ./
      bye
      EOF
  only:
    - main
  environment:
    name: production
    url: http://$FTP_SERVER
