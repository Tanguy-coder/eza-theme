image: php:8.2

stages:
  - lint
  - deploy

# Vérification de la syntaxe PHP
lint_php:
  stage: lint
  script:
    - find . -name "*.php" -exec php -l {} \;

# Déploiement vers le serveur cPanel via SFTP
deploy_to_cpanel:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache lftp
  script:
    - |
      if [ -z "$FTP_USER" ] || [ -z "$FTP_PASSWORD" ] || [ -z "$FTP_SERVER" ]; then
        echo "Error: One or more FTP variables are not set in GitLab CI/CD settings."
        exit 1
      fi
      lftp -e "set sftp:auto-confirm yes; open sftp://$FTP_SERVER; user $FTP_USER $FTP_PASSWORD; cd $FTP_PATH; mirror -R ./ ./ --exclude .git/ --exclude .gitlab-ci.yml --exclude README.md; quit"
  only:
    - main
  environment:
    name: production
    url: http://$FTP_SERVER # À ajuster si nécessaire
