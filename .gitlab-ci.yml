image: php:8.2

stages:
  - lint
  - deploy

# Vérification de la syntaxe PHP
lint_php:
  stage: lint
  script:
    - find . -name "*.php" -exec php -l {} \;

# Déploiement vers le serveur cPanel via FTP
deploy_to_cpanel:
  stage: deploy
  image: alpine:latest
  timeout: 10 minutes
  before_script:
    - apk add --no-cache lftp
    - echo "machine $FTP_SERVER login $FTP_USER password $FTP_PASSWORD" > ~/.netrc
    - chmod 600 ~/.netrc
  script:
    # Debug - afficher le chemin
    - echo "FTP_PATH = $FTP_PATH"
    - echo "Déploiement vers $FTP_SERVER dans le dossier $FTP_PATH"
    # Créer le script lftp avec les variables déjà interpolées
    - |
      cat > /tmp/deploy.lftp << EOFSCRIPT
      set net:timeout 30
      set net:max-retries 3
      set ftp:ssl-allow no
      set ftp:passive-mode yes
      mirror -R --verbose --exclude .git/ --exclude .gitlab-ci.yml --exclude README.md --exclude .gitignore ./ ${FTP_PATH}/
      bye
      EOFSCRIPT
    - cat /tmp/deploy.lftp
    - lftp $FTP_SERVER -f /tmp/deploy.lftp
  after_script:
    - rm -f ~/.netrc /tmp/deploy.lftp
  only:
    - main
  environment:
    name: production
